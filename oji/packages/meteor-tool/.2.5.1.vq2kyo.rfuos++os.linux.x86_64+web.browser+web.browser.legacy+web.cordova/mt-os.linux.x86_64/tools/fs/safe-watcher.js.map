{"version":3,"sources":["tools/fs/safe-watcher.ts"],"names":[],"mappings":"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","sourcesContent":["import { FSWatcher, Stats, BigIntStats } from \"fs\";\nimport { Profile } from \"../tool-env/profile\";\nimport {\n  statOrNull,\n  convertToOSPath,\n  watchFile,\n  unwatchFile,\n  toPosixPath,\n  pathRelative\n} from \"./files\";\nimport {\n  join as nativeJoin\n} from 'path';\nimport nsfw from 'vscode-nsfw';\n\nconst pathwatcher = require('pathwatcher');\n\n// Default to prioritizing changed files, but disable that behavior (and\n// thus prioritize all files equally) if METEOR_WATCH_PRIORITIZE_CHANGED\n// is explicitly set to a string that parses to a falsy value.\nvar PRIORITIZE_CHANGED = true;\nif (process.env.METEOR_WATCH_PRIORITIZE_CHANGED &&\n    ! JSON.parse(process.env.METEOR_WATCH_PRIORITIZE_CHANGED)) {\n  PRIORITIZE_CHANGED = false;\n}\n\nvar DEFAULT_POLLING_INTERVAL =\n  +(process.env.METEOR_WATCH_POLLING_INTERVAL_MS || 5000);\n\nvar NO_WATCHER_POLLING_INTERVAL =\n  +(process.env.METEOR_WATCH_POLLING_INTERVAL_MS || 500);\n\n// This may seems like a long time to wait before actually closing the\n// file watchers, but it's to our advantage if they survive restarts.\nconst WATCHER_CLEANUP_DELAY_MS = 30000;\n\n// Since linux doesn't have recursive file watching, nsfw has to walk the\n// watched folder and create a separate watcher for each subfolder. Until it has a\n// way for us to filter which folders it walks we will continue to use\n// pathwatcher to avoid having too many watchers.\nlet watcherLibrary = process.env.METEOR_WATCHER_LIBRARY || \n  (process.platform === 'linux' ? 'pathwatcher' : 'nsfw');\n\n// Pathwatcher complains (using console.error, ugh) if you try to watch\n// two files with the same stat.ino number but different paths on linux, so we have\n// to deduplicate files by ino.\nconst DEDUPLICATE_BY_INO = watcherLibrary === 'pathwatcher';\n// Set METEOR_WATCH_FORCE_POLLING environment variable to a truthy value to\n// force the use of files.watchFile instead of watchLibrary.watch.\nlet watcherEnabled = ! JSON.parse(\n  process.env.METEOR_WATCH_FORCE_POLLING || \"false\"\n);\n\nconst entriesByIno = new Map;\n\nexport type SafeWatcher = {\n  close: () => void;\n}\n\ntype EntryCallback = (event: string) => void;\n\ninterface Entry extends SafeWatcher {\n  callbacks: Set<EntryCallback>;\n  rewatch: () => void;\n  release: (callback: EntryCallback) => void;\n  _fire: (event: string) => void;\n}\n\nconst entries: Record<string, Entry | null> = Object.create(null);\n\n// Folders that are watched recursively\nlet watchRoots = new Set<string>();\n\n// Set of paths for which a change event has been fired, watched with\n// watchLibrary.watch if available. This could be an LRU cache, but in\n// practice it should never grow large enough for that to matter.\nconst changedPaths = new Set;\n\nfunction hasPriority(absPath: string) {\n  // If we're not prioritizing changed files, then all files have\n  // priority, which means they should be watched with native file\n  // watchers if the platform supports them. If we are prioritizing\n  // changed files, then only changed files get priority.\n  return PRIORITIZE_CHANGED\n    ? changedPaths.has(absPath)\n    : true;\n}\n\nfunction acquireWatcher(absPath: string, callback: EntryCallback) {\n  const entry = entries[absPath] || (\n    entries[absPath] = startNewWatcher(absPath));\n\n  // Watches successfully established in the past may have become invalid\n  // because the watched file was deleted or renamed, so we need to make\n  // sure we're still watching every time we call safeWatcher.watch.\n  entry.rewatch();\n\n  // The size of the entry.callbacks Set also serves as a reference count\n  // for this watcher.\n  entry.callbacks.add(callback);\n\n  return entry;\n}\n\nfunction startNewWatcher(absPath: string): Entry {\n  let stat: Stats | BigIntStats | null | undefined = null;\n\n  if (DEDUPLICATE_BY_INO) {\n    stat = statOrNull(absPath);\n    if (stat && stat.ino > 0 && entriesByIno.has(stat.ino)) {\n      const entry = entriesByIno.get(stat.ino);\n      if (entries[absPath] === entry) {\n        return entry;\n      }\n    }\n  } else {\n    let entry = entries[absPath];\n    if (entry) {\n      return entry;\n    }\n  }\n\n  function safeUnwatch() {\n    if (watcher) {\n      watcher.close();\n      watcher = null;\n      if (stat && stat.ino > 0) {\n        entriesByIno.delete(stat.ino);\n      }\n    }\n  }\n\n  let lastWatcherEventTime = Date.now();\n  const callbacks = new Set<EntryCallback>();\n  let watcherCleanupTimer: ReturnType<typeof setTimeout> | null = null;\n  let watcher: FSWatcher | null = null;\n\n  // Determines the polling interval to be used for the fs.watchFile-based\n  // safety net that works on all platforms and file systems.\n  function getPollingInterval() {\n    if (hasPriority(absPath)) {\n      // Regardless of whether we have a native file watcher and it works\n      // correctly on this file system, poll prioritized files (that is,\n      // files that have been changed at least once) at a higher frequency\n      // (every 500ms by default).\n      return NO_WATCHER_POLLING_INTERVAL;\n    }\n\n    if (watcherEnabled || PRIORITIZE_CHANGED) {\n      // As long as native file watching is enabled (even if it doesn't\n      // work correctly) and the developer hasn't explicitly opted out of\n      // the file watching priority system, poll unchanged files at a\n      // lower frequency (every 5000ms by default).\n      return DEFAULT_POLLING_INTERVAL;\n    }\n\n    // If native file watching is disabled and the developer has\n    // explicitly opted out of the priority system, poll everything at the\n    // higher frequency (every 500ms by default). Note that this leads to\n    // higher idle CPU usage, so the developer may want to adjust the\n    // METEOR_WATCH_POLLING_INTERVAL_MS environment variable.\n    return NO_WATCHER_POLLING_INTERVAL;\n  }\n\n  function fire(event: string) {\n    if (event !== \"change\") {\n      // When we receive a \"delete\" or \"rename\" event, the watcher is\n      // probably not going to generate any more notifications for this\n      // file, so we close and nullify the watcher to ensure that\n      // entry.rewatch() will attempt to reestablish the watcher the next\n      // time we call safeWatcher.watch.\n      safeUnwatch();\n\n      // Make sure we don't throttle the watchFile callback after a\n      // \"delete\" or \"rename\" event, since it is now our only reliable\n      // source of file change notifications.\n      lastWatcherEventTime = 0;\n\n    } else {\n      changedPaths.add(absPath);\n      rewatch();\n    }\n\n    callbacks.forEach(cb => cb(event));\n  }\n\n  function watchWrapper(event: string) {\n    lastWatcherEventTime = Date.now();\n    fire(event);\n\n    // It's tempting to call unwatchFile(absPath, watchFileWrapper) here,\n    // but previous watcher success is no guarantee of future watcher\n    // reliability. For example, watchLibrary.watch works just fine when file\n    // changes originate from within a Vagrant VM, but changes to shared\n    // files made outside the VM are invisible to watcher, so our only\n    // hope of catching them is to continue polling.\n  }\n\n  function rewatch() {\n    if (hasPriority(absPath)) {\n      if (watcher) {\n        // Already watching; nothing to do.\n        return;\n      }\n      watcher = watchLibraryWatch(absPath, watchWrapper);\n    } else if (watcher) {\n      safeUnwatch();\n    }\n\n    // Since we're about to restart the stat-based file watcher, we don't\n    // want to miss any of its events because of the lastWatcherEventTime\n    // throttling that it attempts to do.\n    lastWatcherEventTime = 0;\n\n    // We use files.watchFile in addition to watcher.watch as a fail-safe\n    // to detect file changes even on network file systems.  However\n    // (unless the user disabled watcher or this watcher call failed), we\n    // use a relatively long default polling interval of 5000ms to save\n    // CPU cycles.\n    statWatch(absPath, getPollingInterval(), watchFileWrapper);\n  }\n\n  function watchFileWrapper(newStat: Stats, oldStat: Stats) {\n    if (newStat.ino === 0 &&\n        oldStat.ino === 0 &&\n        +newStat.mtime === +oldStat.mtime) {\n      // Node calls the watchFile listener once with bogus identical stat\n      // objects, which should not trigger a file change event.\n      return;\n    }\n\n    // If a watcher event fired in the last polling interval, ignore\n    // this event.\n    if (Date.now() - lastWatcherEventTime > getPollingInterval()) {\n      fire(\"change\");\n    }\n  }\n\n  const entry = {\n    callbacks,\n    rewatch,\n\n    release(callback: EntryCallback) {\n      if (! entries[absPath]) {\n        return;\n      }\n\n      callbacks.delete(callback);\n      if (callbacks.size > 0) {\n        return;\n      }\n\n      // Once there are no more callbacks in the Set, close both watchers\n      // and nullify the shared data.\n      if (watcherCleanupTimer) {\n        clearTimeout(watcherCleanupTimer);\n      }\n\n      watcherCleanupTimer = setTimeout(() => {\n        if (callbacks.size > 0) {\n          // If another callback was added while the timer was pending, we\n          // can avoid tearing anything down.\n          return;\n        }\n        entry.close();\n      }, WATCHER_CLEANUP_DELAY_MS);\n    },\n\n    close() {\n      if (entries[absPath] !== entry) return;\n      entries[absPath] = null;\n\n      if (watcherCleanupTimer) {\n        clearTimeout(watcherCleanupTimer);\n        watcherCleanupTimer = null;\n      }\n\n      safeUnwatch();\n\n      unwatchFile(absPath, watchFileWrapper);\n    },\n    _fire: fire\n  };\n\n  if (stat && stat.ino > 0) {\n    entriesByIno.set(stat.ino, entry);\n  }\n\n  return entry;\n}\n\nexport function closeAllWatchers() {\n  Object.keys(entries).forEach(absPath => {\n    const entry = entries[absPath];\n    if (entry) {\n      entry.close();\n    }\n  });\n}\n\nconst statWatchers = Object.create(null);\n\nfunction statWatch(\n  absPath: string,\n  interval: number,\n  callback: (current: Stats, previous: Stats) => void,\n) {\n  let statWatcher = statWatchers[absPath];\n\n  if (!statWatcher) {\n    statWatcher = {\n      interval,\n      changeListeners: [],\n      stat: null\n    };\n    statWatchers[absPath] = statWatcher;\n  }\n\n  // If the interval needs to be changed, replace the watcher.\n  // Node will only recreate the watcher with the new interval if all old\n  // watchers are stopped (which unwatchFile does when not passed a\n  // specific listener)\n  if (statWatcher.interval !== interval && statWatcher.stat) {\n    // This stops all stat watchers for the file, not just those created by\n    // statWatch\n    unwatchFile(absPath);\n    statWatcher.stat = null;\n    statWatcher.interval = interval;\n  }\n\n  if (!statWatcher.changeListeners.includes(callback)) {\n    statWatcher.changeListeners.push(callback);\n  }\n\n  if (!statWatcher.stat) {\n    const newStat = watchFile(absPath, {\n      persistent: false, // never persistent\n      interval,\n    }, (newStat, oldStat) => {\n      statWatcher.changeListeners.forEach((\n        listener: (newStat: Stats, oldStat: Stats) => void\n      ) => {\n          listener(newStat, oldStat);\n      });\n    });\n\n    newStat.on(\"stop\", () => {\n      if (statWatchers[absPath] === statWatch) {\n        delete statWatchers[absPath];\n      }\n    });\n\n    statWatcher.stat = newStat;\n  }\n\n  return statWatcher;\n}\n\nfunction watchLibraryWatch(absPath: string, callback: EntryCallback) {\n  if (watcherEnabled && watcherLibrary === 'pathwatcher') {\n    try {\n      return pathwatcher.watch(convertToOSPath(absPath), callback);\n    } catch (e) {\n      maybeSuggestRaisingWatchLimit(e);\n      // ... ignore the error.  We'll still have watchFile, which is good\n      // enough.\n    }\n  }\n\n  return null;\n}\n\nlet suggestedRaisingWatchLimit = false;\n\n// This function is async so that archinfo.host() (which may call\n// utils.execFileSync) will run in a Fiber.\nasync function maybeSuggestRaisingWatchLimit(error: Error & { errno: number }) {\n  var constants = require('constants');\n  var archinfo = require('../utils/archinfo');\n  if (! suggestedRaisingWatchLimit &&\n      // Note: the not-super-documented require('constants') maps from\n      // strings to SYSTEM errno values. System errno values aren't the same\n      // as the numbers used internally by libuv! Once we're upgraded\n      // to Node 0.12, we'll have the system errno as a string (on 'code'),\n      // but the support for that wasn't in Node 0.10's uv.\n      // See our PR https://github.com/atom/node-pathwatcher/pull/53\n      // (and make sure to read the final commit message, not the original\n      // proposed PR, which had a slightly different interface).\n      error.errno === constants.ENOSPC &&\n      // The only suggestion we currently have is for Linux.\n      archinfo.matches(archinfo.host(), 'os.linux')) {\n\n    // Check suggestedRaisingWatchLimit again because archinfo.host() may\n    // have yielded.\n    if (suggestedRaisingWatchLimit) return;\n    suggestedRaisingWatchLimit = true;\n\n    var Console = require('../console/console.js').Console;\n    if (! Console.isHeadless()) {\n      Console.arrowWarn(\n        \"It looks like a simple tweak to your system's configuration will \" +\n          \"make many tools (including this Meteor command) more efficient. \" +\n          \"To learn more, see \" +\n          Console.url(\"https://github.com/meteor/docs/blob/master/long-form/file-change-watcher-efficiency.md\"));\n    }\n  }\n}\n\nexport const watch = Profile(\n  \"safeWatcher.watch\",\n  (absPath: string, callback: EntryCallback) => {\n    const entry = acquireWatcher(absPath, callback);\n    return {\n      close() {\n        entry.release(callback);\n      }\n    } as SafeWatcher;\n  }\n);\n\nconst fireNames = {\n  [nsfw.actions.CREATED]: 'change',\n  [nsfw.actions.MODIFIED]: 'change',\n  [nsfw.actions.DELETED]: 'delete'\n}\n\nexport function addWatchRoot(absPath: string) {\n  if (watchRoots.has(absPath) || watcherLibrary !== 'nsfw' || !watcherEnabled) {\n    return;\n  }\n\n  watchRoots.add(absPath);\n  \n  // If there already is a watcher for a parent directory, there is no need\n  // to create this watcher.\n  for (const path of watchRoots) {\n    let relativePath = pathRelative(path, absPath);\n    if (\n      path !== absPath &&\n      !relativePath.startsWith('..') &&\n      !relativePath.startsWith('/')\n    ) {\n      return;\n    }\n  }\n\n  // TODO: check if there are any existing watchers that are children of this\n  // watcher and stop them\n\n  nsfw(\n    convertToOSPath(absPath),\n    (events) => {\n      events.forEach(event => {\n        if(event.action === nsfw.actions.RENAMED) {\n          let oldPath = nativeJoin(event.directory, event.oldFile);\n          let oldEntry = entries[toPosixPath(oldPath)];\n          if (oldEntry) {\n            oldEntry._fire('rename');\n          }\n\n          let path = nativeJoin(event.newDirectory, event.newFile);\n          let newEntry = entries[toPosixPath(path)];\n          if (newEntry) {\n            newEntry._fire('change');\n          }\n        } else {\n            let path = nativeJoin(event.directory, event.file);\n            let entry = entries[toPosixPath(path)];\n            if (entry) {\n              entry._fire(fireNames[event.action]);\n            }\n        }\n      })\n    }\n  ).then(watcher => {\n    watcher.start()\n  });\n}\n"],"sourceRoot":"","file":"tools/fs/safe-watcher.js.map"}