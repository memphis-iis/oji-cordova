{"version":3,"sources":["/tools/packaging/catalog/catalog-local.js"],"names":["glob","module1","link","sync","v","Profile","optimisticHashOrNull","_","require","buildmessage","files","watch","PackageSource","KNOWN_ISOBUILD_FEATURE_PACKAGES","LocalCatalog","options","self","packages","initialized","localPackageSearchDirs","explicitlyAddedLocalPackageDirs","effectiveLocalPackageDirs","packageLocationWatchSet","WatchSet","_nextId","Object","assign","prototype","toString","JSON","stringify","initialize","assertInCapture","addPatternsToList","patterns","list","forEach","pattern","process","platform","convertToOSPath","p","push","pathResolve","_computeEffectiveLocalPackages","_loadLocalPackages","buildingIsopackets","_requireInitialized","Error","getAllPackageNames","keys","getAllNonTestPackageNames","includeNonCore","ret","nonCoreDir","pathJoin","getCurrentToolsDir","pathSep","each","name","packageSource","sourceRoot","versionRecord","isTest","startsWith","getPackage","has","packageRecord","getSortedVersions","version","getSortedVersionRecords","map","packageName","dependencies","getVersion","getLatestVersion","getVersionBySourceRoot","packageObj","find","enterJob","explicitDir","packageJsPath","packageJsHash","addFile","error","file","searchDir","possiblePackageDirs","readAndWatchDirectory","absPath","include","subdir","substr","length","absPackageDir","initSourceFromDir","packageDir","definiteName","title","rootPath","initFromPackageDirOptions","initFromPackageDir","jobHasMessages","_id","maintainers","lastUpdated","testName","publishedBy","description","metadata","summary","git","getDependencyMetadata","source","published","debugOnly","prodOnly","testOnly","deprecated","deprecatedMessage","containsPlugins","dir","getPackageSource","method","exports"],"mappings":"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","sourcesContent":["\nvar _ = require('underscore');\nvar buildmessage = require('../../utils/buildmessage.js');\nvar files = require('../../fs/files');\nvar watch = require('../../fs/watch');\n\nvar PackageSource = require('../../isobuild/package-source.js');\nimport { sync as glob } from \"glob\";\nimport { Profile } from \"../../tool-env/profile\";\nimport {\n  optimisticHashOrNull,\n} from \"../../fs/optimistic\";\n\n// This variable was duplicated due to an issue on importing it.\n// The issue only happens on node 14, and is most surely related to this: https://nodejs.org/en/blog/release/v14.0.0/\n// !!! When changing this, also change on tools/project-context.js !!!\nconst KNOWN_ISOBUILD_FEATURE_PACKAGES = {\n  // This package directly calls Plugin.registerCompiler. Package authors\n  // must explicitly depend on this feature package to use the API.\n  'isobuild:compiler-plugin': ['1.0.0'],\n\n  // This package directly calls Plugin.registerMinifier. Package authors\n  // must explicitly depend on this feature package to use the API.\n  'isobuild:minifier-plugin': ['1.0.0'],\n\n  // This package directly calls Plugin.registerLinter. Package authors\n  // must explicitly depend on this feature package to use the API.\n  'isobuild:linter-plugin': ['1.0.0'],\n\n  // This package is only published in the isopack-2 format, not isopack-1 or\n  // older. ie, it contains \"source\" files for compiler plugins, not just\n  // JS/CSS/static assets/head/body.\n  // This is implicitly added at publish time to any such package; package\n  // authors don't have to add it explicitly. It isn't relevant for local\n  // packages, which can be rebuilt if possible by the older tool.\n  //\n  // Specifically, this is to avoid the case where a package is published with a\n  // dependency like `api.use('less@1.0.0 || 2.0.0')` and the publication\n  // selects the newer compiler plugin version to generate the isopack. The\n  // published package (if this feature package wasn't implicitly included)\n  // could still be selected by the Version Solver to be used with an old\n  // Isobuild... just because less@2.0.0 depends on isobuild:compiler-plugin\n  // doesn't mean it couldn't choose less@1.0.0, which is not actually\n  // compatible with this published package.  (Constraints of the form described\n  // above are not very helpful, but at least we can prevent old Isobuilds from\n  // choking on confusing packages.)\n  //\n  // (Why not isobuild:isopack@2.0.0? Well, that would imply that Version Solver\n  // would have to choose only one isobuild:isopack feature version, which\n  // doesn't make sense here.)\n  'isobuild:isopack-2': ['1.0.0'],\n\n  // This package uses the `prodOnly` metadata flag, which causes it to\n  // automatically depend on the `isobuild:prod-only` feature package.\n  'isobuild:prod-only': ['1.0.0'],\n\n  // This package depends on a specific version of Cordova. Package authors must\n  // explicitly depend on this feature package to indicate that they are not\n  // compatible with earlier Cordova versions, which is most likely a result of\n  // the Cordova plugins they depend on.\n  // One scenario is a package depending on a Cordova plugin or version\n  // that is only available on npm, which means downloading the plugin is not\n  // supported on versions of Cordova below 5.0.0.\n  'isobuild:cordova': ['5.4.0'],\n\n  // This package requires functionality introduced in meteor-tool@1.5.0\n  // to enable dynamic module fetching via import(...).\n  'isobuild:dynamic-import': ['1.5.0'],\n\n  // This package ensures that processFilesFor{Bundle,Target,Package} are\n  // allowed to return a Promise instead of having to await async\n  // compilation using fibers and/or futures.\n  'isobuild:async-plugins': ['1.6.1'],\n}\n\n// LocalCatalog represents packages located in the application's\n// package directory, other package directories specified via an\n// environment variable, and core packages in the repo if meteor is\n// being run from a git checkout.\nvar LocalCatalog = function (options) {\n  var self = this;\n  options = options || {};\n\n  // Package server data.  Maps package name to a {packageSource, packageRecord,\n  // versionRecord} object.\n  self.packages = {};\n\n  self.initialized = false;\n\n    // Local directories to search for package source trees\n  self.localPackageSearchDirs = null;\n\n  // Package source trees added explicitly through a directory (not through a\n  // parent search directory). We mainly use this to allow the user to run\n  // test-packages against a package in a specific directory.\n  self.explicitlyAddedLocalPackageDirs = [];\n\n  // All packages found either by localPackageSearchDirs or\n  // explicitlyAddedLocalPackageDirs. There is a hierarchy of packages, as\n  // detailed below and there can only be one local version of a package at a\n  // time. This refers to the package by the specific package directory that we\n  // need to process.\n  self.effectiveLocalPackageDirs = [];\n\n  // A WatchSet that detects when the set of packages and their locations\n  // changes. ie, the listings of 'packages' directories, and the contents of\n  // package.js files underneath.  It does NOT track the rest of the source of\n  // the packages: that wouldn't be helpful to the runner since it would be too\n  // coarse to tell if a change is client-only or not.  (But any change to the\n  // layout of where packages live counts as a non-client-only change.)\n  self.packageLocationWatchSet = new watch.WatchSet;\n\n  self._nextId = 1;\n};\n\nObject.assign(LocalCatalog.prototype, {\n  toString: function () {\n    var self = this;\n    return \"LocalCatalog [localPackageSearchDirs=\" +\n      JSON.stringify(self.localPackageSearchDirs) + \"]\";\n  },\n\n  // Initialize the Catalog. This must be called before any other\n  // Catalog function.\n\n  // options:\n  //  - localPackageSearchDirs: an array of paths on local disk, that contain\n  //    subdirectories, that each contain a source tree for a package that\n  //    should override the packages on the package server. For example, if\n  //    there is a package 'foo' that we find through localPackageSearchDirs,\n  //    then we will ignore all versions of 'foo' that we find through the\n  //    package server. Directories that don't exist (or paths that aren't\n  //    directories) will be silently ignored.\n  //  - explicitlyAddedLocalPackageDirs: an array of paths which THEMSELVES\n  //    are package source trees.  Takes precedence over packages found\n  //    via localPackageSearchDirs.\n  //  - buildingIsopackets: true if we are building isopackets\n  initialize(options) {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    options = options || {};\n\n    const addPatternsToList =\n      Profile(\"addPatternsToList\", (patterns, list) => {\n        if (! patterns) {\n          return;\n        }\n\n        patterns.forEach(pattern => {\n          if (process.platform === \"win32\") {\n            pattern = files.convertToOSPath(pattern);\n          }\n\n          glob(pattern).forEach(\n            p => list.push(files.pathResolve(p))\n          );\n        });\n      });\n\n    addPatternsToList(\n      options.localPackageSearchDirs,\n      self.localPackageSearchDirs = [],\n    );\n\n    addPatternsToList(\n      options.explicitlyAddedLocalPackageDirs,\n      self.explicitlyAddedLocalPackageDirs = [],\n    );\n\n    self._computeEffectiveLocalPackages();\n    self._loadLocalPackages(options.buildingIsopackets);\n    self.initialized = true;\n  },\n\n  // Throw if the catalog's self.initialized value has not been set to true.\n  _requireInitialized: function () {\n    var self = this;\n\n    if (! self.initialized)\n      throw new Error(\"catalog not initialized yet?\");\n  },\n\n  // Return an array with the names of all of the packages that we know about,\n  // in no particular order.\n  getAllPackageNames: function (options) {\n    var self = this;\n    self._requireInitialized();\n\n    return Object.keys(self.packages);\n  },\n\n  // Return an array with the names of all of the non-test packages that we know\n  // about, in no particular order.\n  getAllNonTestPackageNames: function ({\n    // Iff options.includeNonCore is truthy, packages in\n    // meteor/packages/non-core/*/packages will be returned.\n    includeNonCore = true,\n  } = {}) {\n    var self = this;\n    self._requireInitialized();\n\n    var ret = [];\n\n    const nonCoreDir = files.pathJoin(\n      files.getCurrentToolsDir(),\n      \"packages\",\n      \"non-core\"\n    ) + files.pathSep;\n\n    _.each(self.packages, function ({\n      packageSource: { sourceRoot },\n      versionRecord: { isTest },\n    }, name) {\n      if (isTest) {\n        return;\n      }\n\n      if (! includeNonCore &&\n          sourceRoot.startsWith(nonCoreDir)) {\n        return;\n      }\n\n      ret.push(name);\n    });\n\n    return ret;\n  },\n\n  // Returns general (non-version-specific) information about a\n  // package, or null if there is no such package.\n  getPackage: function (name, options) {\n    var self = this;\n    self._requireInitialized();\n    options = options || {};\n\n    if (!_.has(self.packages, name))\n      return null;\n    return self.packages[name].packageRecord;\n  },\n\n  // Given a package, returns an array of the versions available (ie, the one\n  // version we have, or an empty array).\n  getSortedVersions: function (name) {\n    var self = this;\n    self._requireInitialized();\n\n    if (!_.has(self.packages, name))\n      return [];\n    return [self.packages[name].versionRecord.version];\n  },\n\n  // Given a package, returns an array of the version records available (ie, the\n  // one version we have, or an empty array). This method is intended for use by\n  // Version Solver's CatalogLoader.\n  //\n  // As a special case, if name is an isobuild:* pseudo-package, returns\n  // (minimal) information about it as well.\n  getSortedVersionRecords: function (name) {\n    var self = this;\n    self._requireInitialized();\n\n    if (_.has(KNOWN_ISOBUILD_FEATURE_PACKAGES, name)) {\n      return KNOWN_ISOBUILD_FEATURE_PACKAGES[name].map(\n        version => ({version, packageName: name, dependencies: {}})\n      );\n    }\n\n    if (!_.has(self.packages, name))\n      return [];\n    return [self.packages[name].versionRecord];\n  },\n\n  // Return information about a particular version of a package, or\n  // null if there is no such package or version.\n  getVersion: function (name, version) {\n    var self = this;\n    self._requireInitialized();\n\n    if (!_.has(self.packages, name))\n      return null;\n    var versionRecord = self.packages[name].versionRecord;\n    if (versionRecord.version !== version)\n      return null;\n    return versionRecord;\n  },\n\n  // As getVersion, but returns info on the latest version of the\n  // package, or null if the package doesn't exist or has no versions.\n  getLatestVersion: function (name) {\n    var self = this;\n\n    if (!_.has(self.packages, name))\n      return null;\n    return self.packages[name].versionRecord;\n  },\n\n  getVersionBySourceRoot: function (sourceRoot) {\n    var self = this;\n    var packageObj = _.find(self.packages, function (p) {\n      return p.packageSource.sourceRoot === sourceRoot;\n    });\n    if (! packageObj)\n      return null;\n    return packageObj.versionRecord;\n  },\n\n  // Compute self.effectiveLocalPackageDirs from self.localPackageSearchDirs and\n  // self.explicitlyAddedLocalPackageDirs.\n  _computeEffectiveLocalPackages() {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    self.effectiveLocalPackageDirs = [];\n\n    buildmessage.enterJob(\"looking for packages\", function () {\n      _.each(self.explicitlyAddedLocalPackageDirs, (explicitDir) => {\n        const packageJsPath = files.pathJoin(explicitDir, \"package.js\");\n        const packageJsHash = optimisticHashOrNull(packageJsPath);\n\n        if (packageJsHash) {\n          self.packageLocationWatchSet.addFile(\n            packageJsPath,\n            packageJsHash,\n          );\n\n          self.effectiveLocalPackageDirs.push(explicitDir);\n\n        } else {\n          // We asked specifically for this directory, but it has no package!\n          buildmessage.error(\"package has no package.js file\", {\n            file: explicitDir\n          });\n        }\n      });\n\n      _.each(self.localPackageSearchDirs, function (searchDir) {\n        var possiblePackageDirs = watch.readAndWatchDirectory(\n          self.packageLocationWatchSet, {\n            absPath: searchDir,\n            include: [/\\/$/]\n          });\n        // Not a directory? Ignore.\n        if (possiblePackageDirs === null)\n          return;\n\n        _.each(possiblePackageDirs, function (subdir) {\n          // readAndWatchDirectory adds a slash to the end of directory names to\n          // differentiate them from filenames. Remove it.\n          subdir = subdir.substr(0, subdir.length - 1);\n          var absPackageDir = files.pathJoin(searchDir, subdir);\n\n          // Consider a directory to be a package source tree if it contains\n          // 'package.js'. (We used to support isopacks in\n          // localPackageSearchDirs, but no longer.)\n\n          const packageJsPath = files.pathJoin(absPackageDir, \"package.js\");\n          const packageJsHash = optimisticHashOrNull(packageJsPath);\n\n          if (packageJsHash) {\n            // Let earlier package directories override later package\n            // directories.\n            self.packageLocationWatchSet.addFile(\n              packageJsPath,\n              packageJsHash,\n            );\n\n            // We don't know the name of the package, so we can't deal with\n            // duplicates yet. We are going to have to rely on the fact that we\n            // are putting these in in order, to be processed in order.\n            self.effectiveLocalPackageDirs.push(absPackageDir);\n          }\n        });\n      });\n    });\n  },\n\n  _loadLocalPackages(buildingIsopackets) {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    // Load the package source from a directory. We don't know the names of our\n    // local packages until we do this.\n    //\n    // THIS MUST BE RUN IN LOAD ORDER. Let's say that we have two directories\n    // for mongo-livedata. The first one processed by this function will be\n    // canonical.  The second one will be ignored.\n    //\n    // (note: this is the behavior that we want for overriding things in\n    //  checkout.  It is not clear that you get good UX if you have two packages\n    //  with the same name in your app. We don't check that.)\n    var initSourceFromDir = function (packageDir, definiteName) {\n      var packageSource = new PackageSource;\n      buildmessage.enterJob({\n        title: \"reading package from `\" + packageDir + \"`\",\n        rootPath: packageDir\n      }, function () {\n        var initFromPackageDirOptions = {\n          buildingIsopackets: !! buildingIsopackets\n        };\n        // If we specified a name, then we know what we want to get and should\n        // pass that into the options. Otherwise, we will use the 'name'\n        // attribute from package-source.js.\n        if (definiteName) {\n          initFromPackageDirOptions.name = definiteName;\n        }\n        packageSource.initFromPackageDir(packageDir, initFromPackageDirOptions);\n        if (buildmessage.jobHasMessages())\n          return;  // recover by ignoring\n\n        // Now that we have initialized the package from package.js, we know its\n        // name.\n        var name = packageSource.name;\n\n        // We should only have one package dir for each name; in this case, we\n        // are going to take the first one we get (since we preserved the order\n        // in which we loaded local package dirs when running this function.)\n        if (_.has(self.packages, name))\n          return;\n\n        self.packages[name] = {\n          packageSource: packageSource,\n          packageRecord: {\n            _id: \"PID\" + self._nextId++,\n            name: name,\n            maintainers: null,\n            lastUpdated: null\n          },\n          versionRecord: {\n            _id: \"VID\" + self._nextId++,\n            packageName: name,\n            testName: packageSource.testName,\n            version: packageSource.version,\n            publishedBy: null,\n            description: packageSource.metadata.summary,\n            git: packageSource.metadata.git,\n            dependencies: packageSource.getDependencyMetadata(),\n            source: null,\n            lastUpdated: null,\n            published: null,\n            isTest: packageSource.isTest,\n            debugOnly: packageSource.debugOnly,\n            prodOnly: packageSource.prodOnly,\n            testOnly: packageSource.testOnly,\n\n            deprecated: packageSource.deprecated,\n            deprecatedMessage: packageSource.deprecatedMessage,\n\n            containsPlugins: packageSource.containsPlugins()\n          }\n        };\n\n        // If this is NOT a test package AND it has tests (tests will be\n        // marked as test packages by package source, so we will not recurse\n        // infinitely), then process that too.\n        if (!packageSource.isTest && packageSource.testName) {\n          initSourceFromDir(packageSource.sourceRoot, packageSource.testName);\n        }\n      });\n    };\n\n    // Load the package sources for packages and their tests into\n    // self.packages.\n    buildmessage.enterJob('initializing packages', function() {\n      _.each(self.effectiveLocalPackageDirs, function (dir) {\n        initSourceFromDir(dir);\n      });\n    });\n  },\n\n  getPackageSource: function (name) {\n    var self = this;\n    if (! _.has(self.packages, name))\n      return null;\n    return self.packages[name].packageSource;\n  }\n});\n\n[\"initialize\",\n \"_computeEffectiveLocalPackages\",\n \"_loadLocalPackages\",\n].forEach(function (method) {\n  this[method] = Profile(\"LocalCatalog#\" + method, this[method]);\n}, LocalCatalog.prototype);\n\nexports.LocalCatalog = LocalCatalog;\n"],"file":"tools/packaging/catalog/catalog-local.js.map"}